<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCPIæŒ‡ä»¤æ™ºèƒ½æœç´¢</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨æœç´¢åŒºåŸŸ -->
        <header class="search-header">
            <h1>ğŸ” SCPIæŒ‡ä»¤æ™ºèƒ½æœç´¢</h1>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¾“å…¥æ‚¨è¦æŸ¥æ‰¾çš„SCPIæŒ‡ä»¤æè¿°ï¼Œå¦‚ï¼šacquire, trigger, frequency measurement..." 
                       autocomplete="off" autofocus>
                <button id="searchBtn">æœç´¢</button>
            </div>
            <div class="search-tips">
                ğŸ’¡ æœç´¢æç¤ºï¼šä½¿ç”¨è‹±æ–‡å…³é”®è¯æ•ˆæœæ›´å¥½ï¼Œå¦‚ "acquire"ã€"trigger"ã€"measurement frequency"
            </div>
        </header>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨æœç´¢ä¸­...</p>
        </div>

        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div id="errorMessage" class="error-message hidden"></div>

        <!-- æœç´¢ç»“æœåŒºåŸŸ -->
        <main class="results-container">
            <div id="resultsHeader" class="results-header hidden">
                <h2>æœç´¢ç»“æœ <span id="searchQuery"></span></h2>
                <div class="results-count">æ‰¾åˆ° <span id="resultCount">0</span> æ¡åŒ¹é…ç»“æœ</div>
            </div>

            <!-- ç»“æœåˆ—è¡¨ -->
            <div id="resultsList" class="results-grid">
                <!-- åŠ¨æ€ç”Ÿæˆçš„æœç´¢ç»“æœå°†æ’å…¥è¿™é‡Œ -->
            </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="footer">
            <p>åŸºäºAIå‘é‡åŒ¹é…çš„SCPIæŒ‡ä»¤æ™ºèƒ½æœç´¢å·¥å…· | 
               <span id="dataInfo">æ•°æ®åŠ è½½ä¸­...</span>
            </p>
        </footer>
    </div>

    <script>
        class SCPISearch {
            constructor() {
                this.initializeElements();
                this.bindEvents();
                this.checkHealth();
            }

            initializeElements() {
                this.searchInput = document.getElementById('searchInput');
                this.searchBtn = document.getElementById('searchBtn');
                this.loading = document.getElementById('loading');
                this.errorMessage = document.getElementById('errorMessage');
                this.resultsHeader = document.getElementById('resultsHeader');
                this.resultsList = document.getElementById('resultsList');
                this.searchQuery = document.getElementById('searchQuery');
                this.resultCount = document.getElementById('resultCount');
                this.dataInfo = document.getElementById('dataInfo');
            }

            bindEvents() {
                this.searchBtn.addEventListener('click', () => this.search());
                this.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.search();
                    }
                });

                // ç¤ºä¾‹æŸ¥è¯¢æŒ‰é’®
                this.addExampleQueries();
            }

            addExampleQueries() {
                const examples = ['acquire', 'trigger', 'measurement frequency', 'é¢‘ç‡æµ‹é‡', 'å¦‚ä½•é…ç½®è§¦å‘'];
                const tipsElement = document.querySelector('.search-tips');
                
                const exampleContainer = document.createElement('div');
                exampleContainer.className = 'example-queries';
                exampleContainer.innerHTML = '<span>å¿«é€Ÿç¤ºä¾‹ï¼š</span>';
                
                examples.forEach(example => {
                    const button = document.createElement('button');
                    button.className = 'example-btn';
                    button.textContent = example;
                    button.onclick = () => {
                        this.searchInput.value = example;
                        this.search();
                    };
                    exampleContainer.appendChild(button);
                });
                
                tipsElement.appendChild(exampleContainer);
            }

            async checkHealth() {
                try {
                    const response = await fetch('/health');
                    const data = await response.json();
                    this.dataInfo.textContent = `å·²åŠ è½½ ${data.data_count} æ¡SCPIæŒ‡ä»¤`;
                } catch (error) {
                    this.dataInfo.textContent = 'æ•°æ®åŠ è½½å¤±è´¥';
                }
            }

            async search() {
                const query = this.searchInput.value.trim();
                if (!query) {
                    this.showError('è¯·è¾“å…¥æœç´¢å†…å®¹');
                    return;
                }

                this.showLoading();
                this.hideError();

                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query: query })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'æœç´¢å¤±è´¥');
                    }

                    this.displayResults(data);

                } catch (error) {
                    this.showError(error.message);
                } finally {
                    this.hideLoading();
                }
            }

            displayResults(data) {
                this.searchQuery.textContent = `"${data.query}"`;
                this.resultCount.textContent = data.total;
                this.resultsHeader.classList.remove('hidden');

                this.resultsList.innerHTML = '';

                if (data.results.length === 0) {
                    this.resultsList.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„SCPIæŒ‡ä»¤</div>';
                    return;
                }

                data.results.forEach(result => {
                    const resultCard = this.createResultCard(result);
                    this.resultsList.appendChild(resultCard);
                });
            }

            createResultCard(result) {
                const card = document.createElement('div');
                card.className = 'result-card';

                const rankIcon = this.getRankIcon(result.rank);
                
                card.innerHTML = `
                    <div class="result-header">
                        <div class="result-rank">${rankIcon} #${result.rank}</div>
                        <div class="result-score">å¾—åˆ†: ${result.score.toFixed(4)}</div>
                    </div>
                    <div class="result-instruction">
                        <strong>ğŸ“ æŒ‡ä»¤:</strong> <code>${this.escapeHtml(result.instruction)}</code>
                    </div>
                    <div class="result-description">
                        <strong>ğŸ“– æè¿°:</strong> ${this.escapeHtml(result.description)}
                    </div>
                    <div class="result-original">
                        <div class="original-header">
                            <strong>ğŸ“„ åŸæ–‡:</strong>
                            <button class="toggle-btn" onclick="this.parentElement.parentElement.classList.toggle('expanded')">
                                å±•å¼€/æ”¶èµ·
                            </button>
                        </div>
                        <div class="original-content">
                            <pre>${this.escapeHtml(result.original_text)}</pre>
                        </div>
                    </div>
                    <div class="result-similarity">
                        <small>ä½™å¼¦ç›¸ä¼¼åº¦: ${result.cosine_similarity.toFixed(4)}</small>
                    </div>
                `;

                return card;
            }

            getRankIcon(rank) {
                const icons = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸'];
                return icons[rank - 1] || 'ğŸ“‹';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showLoading() {
                this.loading.classList.remove('hidden');
                this.searchBtn.disabled = true;
                this.searchBtn.textContent = 'æœç´¢ä¸­...';
            }

            hideLoading() {
                this.loading.classList.add('hidden');
                this.searchBtn.disabled = false;
                this.searchBtn.textContent = 'æœç´¢';
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.classList.remove('hidden');
            }

            hideError() {
                this.errorMessage.classList.add('hidden');
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new SCPISearch();
        });
    </script>
</body>
</html> 